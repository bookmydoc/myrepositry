<?php
 /**
 *
 @package Module Free Order for Joomla! 1.6
 * @link       http://www.test.com/
* @copyright (C) 2011- test rca
 * @license GNU/GPL http://www.gnu.org/copyleft/gpl.html
 */
// no direct access
defined('_JEXEC') or die('Restricted access');
class modsalesrepOrderHelper
{
		
	function sendEmail($params)
	{
		global $mainframe;
		
		$post = JRequest::get('post');
		$jAp =& JFactory::getApplication();
		$user = JFactory::getUser();
    	$member_id = $user->id;
		$jApp = JFactory::getApplication();
		$customer_id = $_POST['customer_name'];
		
		
		//code for connnect secode DB
			$db = JFactory::getDBO();		
            $db2 = modsalesrepOrderHelper::getDBO2();      
		///end code connect secode DB
		
		
		$chkbox = $_POST['chk'];
		$item_ids = $_POST['item_name'];
		$item_qty = $_POST['item_qty'];
		
		$virtuemart_product_ids = "";
		
		$qty_array = array();
		
		foreach($item_ids as $a => $b)
		{
		$virtuemart_product_ids .= $item_ids[$a].","; 
		$qty_array[] = array("item_id"=>$item_ids[$a],"item_qty"=>$item_qty[$a]); 		
		}
		$_SESSION['item_qty_relation'] = $qty_array;
		
		$virtuemart_product_ids = substr($virtuemart_product_ids, 0, strlen($virtuemart_product_ids)-1); 
		
		$virtuemart_product_ids = explode(",", $virtuemart_product_ids);
		
		require(JPATH_ADMINISTRATOR . DS . 'components' . DS . 'com_virtuemart'.DS.'helpers'.DS.'config.php');		
		require(JPATH_SITE . DS . 'components' . DS . 'com_virtuemart' . DS . 'helpers' . DS . 'cart.php');
		$cart = VirtueMartCart::getCart();
		$cart->emptyCart();
		if ($cart)
		 {
			//$virtuemart_product_ids = array("1","2","3");
			$success = true;
			if ($cart->add($virtuemart_product_ids,$success)) {
				$msg = JText::_('COM_VIRTUEMART_PRODUCT_ADDED_SUCCESSFULLY');
				$type = '';
			} else {
				$msg = JText::_('COM_VIRTUEMART_PRODUCT_NOT_ADDED_SUCCESSFULLY');
				$type = 'error';
			}
		}
		
		$usr = JFactory::getUser($customer_id);
		$prices = $cart->getCartPrices();
		$cart->setPaymentMethod("1");
		//$cart->confirmedOrder2($cart, $usr, $prices);
		$orderModel = VmModel::getModel('orders');
		
		if (($orderID = $orderModel->_createOrder($cart, $usr, $prices)) == 0) {
			echo 'Couldn\'t create order','Couldn\'t create order';			
		}
		if (!$orderModel->_createOrderLines($orderID, $cart)) {
			echo 'Couldn\'t create order items','Couldn\'t create order items';			
		}
				
		$orderModel->_updateOrderHist($orderID);
		if (!$orderModel->_writeUserInfo($orderID, $usr, $cart)) {
			echo 'Couldn\'t create order history','Couldn\'t create order history';
		}
		if (!$orderModel-> _createOrderCalcRules($orderID, $cart) ) {
			echo 'Couldn\'t create order items','Couldn\'t create order items';			
		}	
		
		/*$order= $orderModel->getOrder($orderID);
		$dispatcher = JDispatcher::getInstance();
		JPluginHelper::importPlugin('vmshipment');
		JPluginHelper::importPlugin('vmcustom');
		JPluginHelper::importPlugin('vmpayment');
		$returnValues = $dispatcher->trigger('plgVmConfirmedOrder', array($cart, $order));*/
		
		
		///update  ekxob_virtuemart_order_userinfos table detail b'coz it's contain login user detail. 
		$user_info = array();
		$user_detail="select * from #__virtuemart_userinfos as vu ,#__users as u  where vu.virtuemart_user_id = u.id AND  vu.virtuemart_user_id = '".trim($customer_id)."' AND vu.address_type = 'BT'";
		$db->setQuery($user_detail);
		$db->query();
		$user_info=$db->loadAssoc();		
		if(count($user_info) > 0)
		{
		$db->setQuery('UPDATE `#__virtuemart_order_userinfos` SET `company` = "'.$user_info['company'].'", `title` = "'.$user_info['title'].'", `last_name` = "'.$user_info['last_name'].'",`first_name` = "'.$user_info['first_name'].'", `middle_name` = "'.$user_info['middle_name'].'", `phone_1` = "'.$user_info['phone_1'].'",`phone_2` = "'.$user_info['phone_2'].'", `fax` = "'.$user_info['fax'].'", `address_1` = "'.$user_info['address_1'].'", `address_2` = "'.$user_info['address_2'].'",`city` = "'.$user_info['city'].'", `virtuemart_state_id` = "'.$user_info['virtuemart_state_id'].'", `virtuemart_country_id` = "'.$user_info['virtuemart_country_id'].'",`zip`="'.$user_info['zip'].'",`email`="'.$user_info['email'].'" WHERE `virtuemart_order_id` ="'.$orderID.'" AND `address_type`="BT" AND `virtuemart_user_id` ="'.trim($customer_id).'"');		
		$db->query();
		}
		
		$s_user_info = array();
		
		$s_user_detail="select * from #__virtuemart_userinfos as vu ,#__users as u  where vu.virtuemart_user_id = u.id AND  vu.virtuemart_user_id = '".trim($customer_id)."' AND vu.address_type = 'ST'";
		$db->setQuery($s_user_detail);
		$db->query();
		$s_user_info=$db->loadAssoc();		
		if(count($s_user_info) > 0)
		{
		$db->setQuery('UPDATE `#__virtuemart_order_userinfos` SET `company` = "'.$s_user_info['company'].'", `title` = "'.$s_user_info['title'].'", `last_name` = "'.$s_user_info['last_name'].'",`first_name` = "'.$s_user_info['first_name'].'", `middle_name` = "'.$s_user_info['middle_name'].'", `phone_1` = "'.$s_user_info['phone_1'].'",`phone_2` = "'.$user_info['phone_2'].'", `fax` = "'.$user_info['fax'].'", `address_1` = "'.$s_user_info['address_1'].'", `address_2` = "'.$s_user_info['address_2'].'",`city` = "'.$s_user_info['city'].'", `virtuemart_state_id` = "'.$s_user_info['virtuemart_state_id'].'", `virtuemart_country_id` = "'.$s_user_info['virtuemart_country_id'].'",`zip`="'.$s_user_info['zip'].'",`email`="'.$s_user_info['email'].'" WHERE `virtuemart_order_id` ="'.$orderID.'" AND `address_type`="ST" AND `virtuemart_user_id` ="'.trim($customer_id).'"');		
		$db->query();
		}
		else
		{
		if(count($user_info) > 0){
		$db->setQuery('UPDATE `#__virtuemart_order_userinfos` SET `company` = "'.$user_info['company'].'", `title` = "'.$user_info['title'].'", `last_name` = "'.$user_info['last_name'].'",`first_name` = "'.$user_info['first_name'].'", `middle_name` = "'.$user_info['middle_name'].'", `phone_1` = "'.$user_info['phone_1'].'",`phone_2` = "'.$user_info['phone_2'].'", `fax` = "'.$user_info['fax'].'", `address_1` = "'.$user_info['address_1'].'", `address_2` = "'.$user_info['address_2'].'",`city` = "'.$user_info['city'].'", `virtuemart_state_id` = "'.$user_info['virtuemart_state_id'].'", `virtuemart_country_id` = "'.$user_info['virtuemart_country_id'].'",`zip`="'.$user_info['zip'].'",`email`="'.$user_info['email'].'" WHERE `virtuemart_order_id` ="'.$orderID.'" AND `address_type`="ST" AND `virtuemart_user_id` ="'.trim($customer_id).'"');		
		$db->query();
		}
		}
		///end code
		
		$db->setQuery('INSERT INTO #__virtuemart_order_salerep ( id, virtuemart_order_id, virtuemart_user_id )' .
                        ' VALUES ( "", '.(int)$orderID.', '.(int)$member_id.')');
                if (!$db->query()) {
                       echo $db->getErrorMsg();                       
                }
			
		echo "<div style='color:#569E01;font-size:15px;'>Order inserted Successfully. Order Id is --> ".$orderID."</div>";
		if($orderID > 0){
		unset($_SESSION['item_qty_relation']);
		$_SESSION['item_qty_relation'] = ""; 
		}
		$cart->emptyCart();
		/////----add order in db1_bri tables----/////
		
		function findListID($tablename)
	{	
		//code for connnect secode DB
			$db = JFactory::getDBO();		
            $db2 = modsalesrepOrderHelper::getDBO2();   
		///end code connect secode DB
			
		$new_number_x=(rand(1,10000000)); 
		$customerListID_data= '134'.$new_number_x;
		$sql='select ListID from '.$tablename.' order by ListID DESC limit 0,1';
		$db2->setQuery($sql);
		$db2->query();
		$row = $db2->getNumRows();
		if($row>0)
		{
			$record = $db2->loadAssoc();
			$new_number=explode('-',$record['ListID']);
			$customerListID=$new_number[0]+1;
			$ListID=$customerListID.'-'.$customerListID_data;
		}
		else
		{
			$ListID='80000001-'.$customerListID_data;
			
		}
		return $ListID;
	}
	
	function add_customer()
	{
		//code for connnect secode DB
			$db = JFactory::getDBO();		
            $db2 = modsalesrepOrderHelper::getDBO2();   
		///end code connect secode DB
		
		$select="select * from #__users";		
		$db->setQuery($select);
		$db->query();		
		$rows = $db->loadAssocList();
		//while($rows=mysql_fetch_assoc($result))
		//while($rows = $db->loadAssocList())
		//foreach($row as $rows)
		for($w=0;$w<count($rows);$w++)
		{
					
			$select_customer="select * from customer where Name = '".trim($rows[$w]['name'])."'";
			$db2->setQuery($select_customer);
			$db2->query();
			$row_data = $db2->getNumRows();			
			
			if($row_data==0)
			{
				
				$customer_detail="select * from #__virtuemart_userinfos where virtuemart_user_id = '".$rows[$w]['id']."' AND address_type = 'BT'";
				$db->setQuery($customer_detail);
				$db->query();
				$c_rows = $db->getNumRows();
				$customer_info=$db->loadAssoc();
				if($c_rows>0)
				{						
					$addreess_type=$customer_info['address_type'];
					$company_name=$customer_info['company'];
					$title=$customer_info['title'];
					$last_name=$customer_info['last_name'];
					$first_name=$customer_info['first_name'];
					$middle_name=$customer_info['middle_name'];
					$phone=$customer_info['phone_1'];
					$mobile=$customer_info['phone_2'];
					$fax=$customer_info['fax'];
					$address_1=$customer_info['address_1'];
					$address_2=$customer_info['address_2'];
					$city=$customer_info['city'];
					$zip=$customer_info['zip'];
					$virtuemart_state_id=$customer_info['virtuemart_state_id'];
					$country_id=$customer_info['virtuemart_country_id'];
					/* Fetch State list */ 
					$select_state="select cnt.country_3_code as country,st.state_2_code as state from #__virtuemart_states as st, #__virtuemart_countries as cnt  where st.virtuemart_state_id='".$virtuemart_state_id."' and cnt.virtuemart_country_id ='".$country_id."'";
					$db->setQuery($select_state);
					$db->query();
					$state=$db->loadAssoc();	
					$state_name=$state['state'];
					$country_name=$state['country'];
					
				}
				
				$customer_st_detail="select * from #__virtuemart_userinfos where virtuemart_user_id = '".$rows[$w]['id']."' AND address_type = 'ST'";
				$db->setQuery($customer_st_detail);
				$db->query();
				$st_rows = $db->getNumRows();
				$customer_st_info=$db->loadAssoc();
				if($st_rows>0)				
					{	
						$s_company_name=$customer_st_info['company'];
						$s_title=$customer_st_info['title'];
						$s_last_name=$customer_st_info['last_name'];
						$s_first_name=$customer_st_info['first_name'];
						$s_middle_name=$customer_st_info['middle_name'];
										
						$s_phone=$customer_st_info['phone_1'];
						$s_mobile=$customer_st_info['phone_2'];
						$s_fax=$customer_st_info['fax'];
						$s_address_1=$customer_st_info['address_1'];
						$s_address_2=$customer_st_info['address_2'];
						$s_city=$customer_st_info['city'];
						$s_zip=$customer_st_info['zip'];
						$virtuemart_state_id_st=$customer_st_info['virtuemart_state_id'];
						$country_id_st=$customer_st_info['virtuemart_country_id'];
					/* Fetch State list */ 
					$select_st_state="select cnt.country_3_code as country,st.state_2_code as state from #__virtuemart_states as st, #__virtuemart_countries as cnt  where st.virtuemart_state_id='".$virtuemart_state_id_st."' and cnt.virtuemart_country_id ='".$country_id_st."'";
							$db->setQuery($select_st_state);
							$db->query();
							$state_st=$db->loadAssoc();					
					
						$s_state_name=$state_st['state'];
						$s_country_name=$state_st['country'];
						
					}
					else
					{	
						$s_company_name='';
						$s_title='';
						$s_last_name='';
						$s_first_name='';
						$s_middle_name='';
						$s_phone='';
						$s_mobile='';
						$s_fax='';
						$s_address_1='';
						$s_address_2='';
						$s_city='';
						$s_zip='';
						$s_state_name='';
						$s_country_name='';
					}
					
					
					
					
				$new_number=(rand(1,10000000)); 
				$edit_seq='134'.$new_number;
				$TimeCreated=date('m/d/Y h:m:s A'); 
				$ListID=findListID('customer');
				$true='true';
				
				
				
			$insert="insert into customer (ListID,TimeCreated,TimeModified,EditSequence,Name,FullName,IsActive,Email,Status,CompanyName,Salutation,FirstName,MiddleName,LastName,BillAddress_Addr1,BillAddress_Addr2,BillAddress_Addr3,BillAddress_Addr4,BillAddress_City,BillAddress_State,BillAddress_PostalCode,BillAddress_Country,ShipAddress_Addr1, ShipAddress_Addr2,ShipAddress_Addr3, ShipAddress_Addr4,ShipAddress_City,ShipAddress_State,ShipAddress_PostalCode,ShipAddress_Country,Phone,Mobile,Fax,Contact,Balance,TotalBalance,JobStatus,Sublevel) values ('".$ListID."','".$TimeCreated."',now(),'".$edit_seq."','".trim($rows[$w]['name'])."','".trim(ucwords($first_name.' '.$last_name))."','".trim($true)."','".trim($rows[$w]['email'])."','".ADD."','".trim($company_name)."','".trim($title)."','".trim($first_name)."','".trim($middle_nam)."','".trim($last_name)."','".trim($company_name)."','".trim($first_name." ".$last_name)."','".trim($address_1)."','".trim($address_2)."','".trim($city)."','".trim($state_name)."','".trim($zip)."','".trim($country_name)."','".trim($s_company_name)."','".trim($s_first_name." ".$s_last_name)."','".trim($s_address_1)."','".trim($s_address_2)."','".trim($s_city)."','".trim($s_state_name)."','".trim($s_zip)."','".trim($s_country_name)."','".trim($phone)."','".trim($mobile)."','".trim($fax)."','".trim(ucwords($first_name.' '.$last_name))."','0','0','None','0')";	
						
			$db2->setQuery($insert);
			$db2->query();
			
			}
				
		}
	}

	
	
	
	add_customer();
	

	
	
	$select_order="SELECT * FROM #__virtuemart_order_items AS o
INNER JOIN #__virtuemart_products AS p ON p.product_sku = o.order_item_sku INNER JOIN #__virtuemart_orders  as vo on  o.virtuemart_order_id = vo.virtuemart_order_id INNER JOIN #__users as u on vo.virtuemart_user_id=u.id where o.virtuemart_order_id not in( select virtuemart_order_id from #__quickbook_order_histories)
group by o.virtuemart_order_id";

	$i=findListID("salesorder");
	$j=35888;

	$db->setQuery($select_order);
	$db->query();
	$so = $db->loadAssocList();
	
	//while($so=mysql_fetch_assoc($result))
	//foreach($rows as $so)
	for($a=0;$a<count($so);$a++)
	{
		$order_id_vituemart = $so[$a]['virtuemart_order_id'];
		$items_result = array();
	   $select_items="SELECT * FROM #__virtuemart_order_items WHERE virtuemart_order_id =".$order_id_vituemart;
		$db->setQuery($select_items);
		$db->query();
		$row_data = $db->loadAssocList();
		for($z=0;$z<count($row_data);$z++){
			$items_result[] = $row_data[$z];			
		}
		
		$select_qb="select c.ListID as customer_id, i_inv.ListID as item_id ,c.Name as customer_name ,c.FullName,c.CompanyName,c.BillAddress_Addr1,c.BillAddress_Addr2 ,c.BillAddress_City,c.BillAddress_State,c.BillAddress_Country,i_inv.Name as item_name from customer as c ,iteminventory as i_inv where c.Name = '".$so[$a]['name']."'  and i_inv.Name = '".$so[$a]['order_item_sku']."'";
				
		$db2->setQuery($select_qb);
		$db2->query();
		$record = $db2->loadAssoc();
		$row_data = $db2->getNumRows();
		
		
		if(count($record) > 0)
		{
			$insert_order="insert into salesorder (TxnID,CustomerRef_ListID,CustomerRef_FullName,Status,TimeCreated,TimeModified,BillAddress_Addr1,BillAddress_Addr2,BillAddress_City,BillAddress_State,BillAddress_Country) values ('".$i."','".$record['customer_id']."','".$record['customer_name']."','ADD',now(),now(),'".$record['BillAddress_Addr1']."','".$record['BillAddress_Addr2']."','".$record['BillAddress_City']."','".$record['BillAddress_State']."','".$record['BillAddress_Country']."')";			 
			$db2->setQuery($insert_order);
			$db2->query();
			//echo "</br>";
			for($k=0;$k < count($items_result);$k++)
			{ 
			
			$select_qb1 ="select c.ListID as customer_id, i_inv.ListID as item_id ,c.Name as customer_name ,c.FullName,c.CompanyName,c.BillAddress_Addr1,c.BillAddress_Addr2 ,c.BillAddress_City,c.BillAddress_State,c.BillAddress_Country,i_inv.Name as item_name from customer as c ,iteminventory as i_inv where c.Name = '".$so[$a]['name']."'  and i_inv.Name = '".$items_result[$k]['order_item_sku']."'";						
			$db2->setQuery($select_qb1);
			$db2->query();
			$record1 = $db2->loadAssoc();
			//echo "</br>";
			//print_r($record1);
			$insert_sales_inline="insert into salesorderlinedetail (TxnLineID,ItemRef_ListID,ItemRef_FullName,Quantity,IDKEY) values ('".$j."','".$record1['item_id']."','".$record1['item_name']."','".$items_result[$k]['product_quantity']."','".$i."')";
			$db2->setQuery($insert_sales_inline);
			$db2->query();
			//echo "</br>";
			}
			
			 $virtuemart_to_quickbook_order_history="insert into #__quickbook_order_histories (id,virtuemart_order_id) values ('','".$order_id_vituemart."')";
			 $db->setQuery($virtuemart_to_quickbook_order_history);
			 $db->query();
			
			
		}
	$i++; $j++;
	}
			
	
		/////----end code----/////		
		
		return true;
	} 
	
	function &getDBO2() {
        static $dbo2 = null;

        if (!$dbo2) {
            $option = array();
            $option['driver'] = 'mysql';       // Database driver name
            $option['host'] = '172.25.25.11';  // Database host name
            $option['user'] = 'db1_bri';       // User for database authentication
            $option['password'] = '123';   	   // Password for database authentication
            $option['database'] = 'db1_bri';   // Database name
            $option['prefix'] = '';            // Database prefix 
            //
            $dbo2 = & JDatabase::getInstance($option);
        }

        return $dbo2;
    }
} 
?>


